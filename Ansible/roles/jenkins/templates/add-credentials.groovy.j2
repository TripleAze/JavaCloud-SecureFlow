import jenkins.model.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.common.*
import com.cloudbees.plugins.credentials.domains.*
import com.cloudbees.jenkins.plugins.sshcredentials.impl.*
import hudson.util.Secret

def pluginManager = Jenkins.instance.pluginManager
def sshCredsPlugin = pluginManager.getPlugin("ssh-credentials")

if (sshCredsPlugin == null || !sshCredsPlugin.isActive()) {
  println "ERROR: ssh-credentials plugin is not installed or active. Restart may be required."
  return
}

def domain = Domain.global()
def store = Jenkins.instance.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].getStore()

def tomcatKey = '''{{ lookup('file', ansible_ssh_private_key_file) }}'''

def existingCredentials = com.cloudbees.plugins.credentials.CredentialsMatchers.firstOrNull(
  com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
    com.cloudbees.plugins.credentials.common.StandardUsernameCredentials.class,
    Jenkins.instance,
    hudson.security.ACL.SYSTEM,
    new com.cloudbees.plugins.credentials.domains.DomainRequirement()
  ),
  com.cloudbees.plugins.credentials.CredentialsMatchers.withId("tomcat-ssh-key")
)

if (existingCredentials == null) {
  def credentials = new BasicSSHUserPrivateKey(
    CredentialsScope.GLOBAL,
    "tomcat-ssh-key",
    "{{ tomcat_user | default('ec2-user') }}",
    new BasicSSHUserPrivateKey.DirectEntryPrivateKeySource(tomcatKey),
    "",
    "SSH Key for Tomcat Server"
  )
  store.addCredentials(domain, credentials)
  println "Credential added successfully"
} else {
  println "Credential already exists"
}
